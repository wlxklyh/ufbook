<!-- Giscus 评论系统 -->
{% if config.extra.giscus_enabled %}
<div class="giscus-comments">
  <h2 class="comments-title">评论区</h2>
  <script src="https://giscus.app/client.js"
          data-repo="{{ config.extra.giscus.repo }}"
          data-repo-id="{{ config.extra.giscus.repo_id }}"
          data-category="{{ config.extra.giscus.category }}"
          data-category-id="{{ config.extra.giscus.category_id }}"
          data-mapping="{{ config.extra.giscus.mapping | default('pathname') }}"
          data-strict="{{ config.extra.giscus.strict | default('0') }}"
          data-reactions-enabled="{{ config.extra.giscus.reactions_enabled | default('1') }}"
          data-emit-metadata="{{ config.extra.giscus.emit_metadata | default('0') }}"
          data-input-position="{{ config.extra.giscus.input_position | default('bottom') }}"
          data-theme="{{ config.extra.giscus.theme | default('preferred_color_scheme') }}"
          data-lang="{{ config.extra.giscus.lang | default('zh-CN') }}"
          data-loading="{{ config.extra.giscus.loading | default('lazy') }}"
          crossorigin="anonymous"
          async>
  </script>
</div>

<style>
  .giscus-comments {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--md-default-fg-color--lightest);
  }
  
  .comments-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: var(--md-default-fg-color);
  }

  /* 适配深色模式 */
  [data-md-color-scheme="slate"] .giscus-comments {
    border-top-color: var(--md-default-fg-color--lightest);
  }
</style>

<script>
  // 监听主题切换，同步更新 Giscus 主题
  var giscusTheme = "preferred_color_scheme";
  
  // 检测系统主题
  var palette = document.querySelector("[data-md-color-scheme]");
  if (palette) {
    var scheme = palette.getAttribute("data-md-color-scheme");
    giscusTheme = scheme === "slate" ? "dark" : "light";
  }

  // 监听主题切换事件
  var observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.attributeName === "data-md-color-scheme") {
        var scheme = mutation.target.getAttribute("data-md-color-scheme");
        var newTheme = scheme === "slate" ? "dark" : "light";
        
        // 发送消息给 Giscus iframe 更新主题
        var iframe = document.querySelector('iframe.giscus-frame');
        if (iframe) {
          iframe.contentWindow.postMessage(
            { giscus: { setConfig: { theme: newTheme } } },
            'https://giscus.app'
          );
        }
      }
    });
  });

  // 开始观察
  var target = document.querySelector("[data-md-color-scheme]");
  if (target) {
    observer.observe(target, { attributes: true });
  }
</script>
{% endif %}


